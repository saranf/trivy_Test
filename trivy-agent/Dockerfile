# ü§ñ Trivy Agent - Í≤ΩÎüâ Î≥¥Ïïà Ïä§Ï∫êÎÑà ÏóêÏù¥Ï†ÑÌä∏
# 
# ÎπåÎìú: docker build -t trivy-agent .
# Ïã§Ìñâ: docker run -d --name trivy-agent \
#         -v /var/run/docker.sock:/var/run/docker.sock \
#         -e CENTRAL_API_URL=https://your-server.com/api/agent.php \
#         -e AGENT_TOKEN=your-token \
#         trivy-agent

FROM alpine:3.19

LABEL maintainer="Trivy Agent"
LABEL description="Lightweight security scanner agent with extensible collectors"

# ÌïÑÏàò Ìå®ÌÇ§ÏßÄ ÏÑ§Ïπò
RUN apk add --no-cache \
    bash \
    curl \
    jq \
    docker-cli \
    procps \
    iptables \
    net-tools \
    coreutils \
    util-linux

# Trivy ÏÑ§Ïπò (v0.29.2 - ÏïàÏ†ï Î≤ÑÏ†Ñ)
ENV TRIVY_VERSION=0.29.2
RUN curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v${TRIVY_VERSION}

# ÏóêÏù¥Ï†ÑÌä∏ ÎîîÎ†âÌÜ†Î¶¨ Íµ¨Ï°∞
RUN mkdir -p /opt/agent/collectors /opt/agent/data /opt/agent/logs

# ÏóêÏù¥Ï†ÑÌä∏ Ïä§ÌÅ¨Î¶ΩÌä∏ Î≥µÏÇ¨
COPY agent.sh /opt/agent/
COPY collectors/ /opt/agent/collectors/

RUN chmod +x /opt/agent/agent.sh /opt/agent/collectors/*.sh 2>/dev/null || true

WORKDIR /opt/agent

# ÌôòÍ≤Ω Î≥ÄÏàò
ENV CENTRAL_API_URL=""
ENV AGENT_TOKEN=""
ENV AGENT_ID=""
ENV HEARTBEAT_INTERVAL=60
ENV SCAN_INTERVAL=300
ENV COLLECTORS="trivy"
ENV LOG_LEVEL=INFO

# Ìó¨Ïä§Ï≤¥ÌÅ¨
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -sf "${CENTRAL_API_URL}?action=heartbeat" || exit 1

ENTRYPOINT ["/opt/agent/agent.sh"]

