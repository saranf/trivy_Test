# ü§ñ Trivy Agent - Í≤ΩÎüâ Î≥¥Ïïà Ïä§Ï∫êÎÑà ÏóêÏù¥Ï†ÑÌä∏
#
# ÎπåÎìú: docker build -t trivy-agent .
# Ïã§Ìñâ: docker run -d --name trivy-agent \
#         -v /var/run/docker.sock:/var/run/docker.sock \
#         -e AGENT_TOKEN=your-token \
#         -p 8888:8888 \
#         trivy-agent

FROM alpine:3.19

LABEL maintainer="Trivy Agent"
LABEL description="Lightweight security scanner agent with HTTP API"

# ÌïÑÏàò Ìå®ÌÇ§ÏßÄ ÏÑ§Ïπò
RUN apk add --no-cache \
    bash \
    curl \
    jq \
    docker-cli \
    procps \
    iptables \
    net-tools \
    coreutils \
    util-linux \
    python3 \
    py3-pip

# Flask ÏÑ§Ïπò (Í≤ΩÎüâ HTTP ÏÑúÎ≤Ñ)
RUN pip3 install --no-cache-dir --break-system-packages flask gunicorn

# Trivy ÏÑ§Ïπò (v0.29.2 - ÏïàÏ†ï Î≤ÑÏ†Ñ)
ENV TRIVY_VERSION=0.29.2
RUN curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v${TRIVY_VERSION}

# ÏóêÏù¥Ï†ÑÌä∏ ÎîîÎ†âÌÜ†Î¶¨ Íµ¨Ï°∞
RUN mkdir -p /opt/agent/collectors /opt/agent/data /opt/agent/logs

# ÏóêÏù¥Ï†ÑÌä∏ Ïä§ÌÅ¨Î¶ΩÌä∏ Î≥µÏÇ¨
COPY agent.sh /opt/agent/
COPY api_server.py /opt/agent/
COPY collectors/ /opt/agent/collectors/

RUN chmod +x /opt/agent/agent.sh /opt/agent/collectors/*.sh 2>/dev/null || true

WORKDIR /opt/agent

# ÌôòÍ≤Ω Î≥ÄÏàò
ENV CENTRAL_API_URL=""
ENV AGENT_TOKEN=""
ENV AGENT_ID=""
ENV HEARTBEAT_INTERVAL=60
ENV SCAN_INTERVAL=300
ENV COLLECTORS="trivy"
ENV LOG_LEVEL=INFO
ENV API_PORT=8888

# HTTP API Ìè¨Ìä∏
EXPOSE 8888

# Ìó¨Ïä§Ï≤¥ÌÅ¨
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD curl -sf http://localhost:8888/health || exit 1

ENTRYPOINT ["/opt/agent/agent.sh"]

