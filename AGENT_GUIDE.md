# ðŸ¤– Trivy Agent ê°€ì´ë“œ

> ë¶„ì‚° ì„œë²„ í™˜ê²½ì—ì„œ ë³´ì•ˆ ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ëŠ” ê²½ëŸ‰ ì—ì´ì „íŠ¸ ì‹œìŠ¤í…œ

## ðŸ“‹ ëª©ì°¨

1. [ì•„í‚¤í…ì²˜ ê°œìš”](#ì•„í‚¤í…ì²˜-ê°œìš”)
2. [êµ¬ì„± ìš”ì†Œ](#êµ¬ì„±-ìš”ì†Œ)
3. [ì„¤ì¹˜ ë°©ë²•](#ì„¤ì¹˜-ë°©ë²•)
4. [ë™ìž‘ ì›ë¦¬](#ë™ìž‘-ì›ë¦¬)
5. [Collector í™•ìž¥](#collector-í™•ìž¥)
6. [ìžì‚° ê´€ë¦¬](#ìžì‚°-ê´€ë¦¬)
7. [íŠ¸ëŸ¬ë¸”ìŠˆíŒ…](#íŠ¸ëŸ¬ë¸”ìŠˆíŒ…)

---

## ðŸ—ï¸ ì•„í‚¤í…ì²˜ ê°œìš”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Central Server                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Nginx     â”‚  â”‚  PHP API    â”‚  â”‚      MySQL          â”‚  â”‚
â”‚  â”‚   :6987     â”‚â”€â”€â”‚  /api/      â”‚â”€â”€â”‚  agents             â”‚  â”‚
â”‚  â”‚             â”‚  â”‚  agent.php  â”‚  â”‚  agent_data         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  agent_commands     â”‚  â”‚
â”‚                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–²                    â”‚
         â”‚ HTTPS POST         â”‚ Commands
         â”‚ (register,         â”‚ (scan, collect)
         â”‚  heartbeat,        â–¼
         â”‚  report)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Server A      â”‚    â”‚   Server B      â”‚    â”‚   Server C      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Agent    â”‚  â”‚    â”‚  â”‚  Agent    â”‚  â”‚    â”‚  â”‚  Agent    â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚    â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚    â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ Collectorsâ”‚  â”‚    â”‚  â”‚ Collectorsâ”‚  â”‚    â”‚  â”‚ Collectorsâ”‚  â”‚
â”‚  â”‚ - trivy   â”‚  â”‚    â”‚  â”‚ - trivy   â”‚  â”‚    â”‚  â”‚ - trivy   â”‚  â”‚
â”‚  â”‚ - system  â”‚  â”‚    â”‚  â”‚ - iptablesâ”‚  â”‚    â”‚  â”‚ - docker  â”‚  â”‚
â”‚  â”‚ - docker  â”‚  â”‚    â”‚  â”‚ - network â”‚  â”‚    â”‚  â”‚ - custom  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚   [ê°œë°œ]        â”‚    â”‚   [ìš´ì˜]        â”‚    â”‚   [ìŠ¤í…Œì´ì§•]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### í•µì‹¬ íŠ¹ì§•

| íŠ¹ì§• | ì„¤ëª… |
|------|------|
| **ê²½ëŸ‰** | Alpine ê¸°ë°˜ ~50MB ì´ë¯¸ì§€ |
| **í™•ìž¥ì„±** | í”ŒëŸ¬ê·¸ì¸ ë°©ì‹ Collector |
| **ìžì‚° ê´€ë¦¬** | íƒœê·¸ ê¸°ë°˜ ì„œë²„/ì»¨í…Œì´ë„ˆ ê·¸ë£¹í•‘ |
| **ì‹¤ì‹œê°„** | Docker ì´ë²¤íŠ¸ ê°ì‹œ + ì£¼ê¸°ì  ìŠ¤ìº” |
| **ì–‘ë°©í–¥** | ì¤‘ì•™ì—ì„œ ëª…ë ¹ ì „ì†¡ ê°€ëŠ¥ |

---

## ðŸ§© êµ¬ì„± ìš”ì†Œ

### 1. Central Server (ê¸°ì¡´ trivy_Test)

| ì»´í¬ë„ŒíŠ¸ | ê²½ë¡œ | ì—­í•  |
|----------|------|------|
| Agent API | `/api/agent.php` | ì—ì´ì „íŠ¸ í†µì‹  (ë“±ë¡, í•˜íŠ¸ë¹„íŠ¸, ë¦¬í¬íŠ¸) |
| Admin API | `/api/agent_admin.php` | ê´€ë¦¬ìžìš© (ëª©ë¡, ëª…ë ¹ ì „ì†¡) |
| Dashboard | `/agents.php` | ì—ì´ì „íŠ¸ ê´€ë¦¬ UI |
| DB Tables | `agents`, `agent_data`, `agent_commands` | ë°ì´í„° ì €ìž¥ |

### 2. Trivy Agent

```
trivy-agent/
â”œâ”€â”€ Dockerfile          # Alpine + Trivy + ë„êµ¬ë“¤
â”œâ”€â”€ agent.sh            # ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸
â”œâ”€â”€ collectors/         # ë°ì´í„° ìˆ˜ì§‘ ëª¨ë“ˆ
â”‚   â”œâ”€â”€ system.sh       # CPU, ë©”ëª¨ë¦¬, ë””ìŠ¤í¬
â”‚   â”œâ”€â”€ processes.sh    # ps aux, í¬íŠ¸
â”‚   â”œâ”€â”€ docker.sh       # ì»¨í…Œì´ë„ˆ, ì´ë¯¸ì§€
â”‚   â”œâ”€â”€ iptables.sh     # ë°©í™”ë²½ ê·œì¹™
â”‚   â””â”€â”€ network.sh      # ë„¤íŠ¸ì›Œí¬ ì •ë³´
â””â”€â”€ scripts/
    â””â”€â”€ install.sh      # ì›í´ë¦­ ì„¤ì¹˜
```

### 3. Collector ì¢…ë¥˜

| Collector | ìˆ˜ì§‘ ë°ì´í„° | ìš©ë„ |
|-----------|------------|------|
| `trivy` | ì»¨í…Œì´ë„ˆ ì·¨ì•½ì  | ë³´ì•ˆ ìŠ¤ìº” |
| `system` | CPU, ë©”ëª¨ë¦¬, ë””ìŠ¤í¬, ì—…íƒ€ìž„ | ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ |
| `processes` | í”„ë¡œì„¸ìŠ¤ ëª©ë¡, ë¦¬ìŠ¤ë‹ í¬íŠ¸ | í”„ë¡œì„¸ìŠ¤ ê°ì‹œ |
| `docker` | ì»¨í…Œì´ë„ˆ, ì´ë¯¸ì§€, ë³¼ë¥¨ | Docker ìžì‚° |
| `iptables` | INPUT/OUTPUT/FORWARD ê·œì¹™ | ë°©í™”ë²½ ê°ì‚¬ |
| `network` | ì¸í„°íŽ˜ì´ìŠ¤, ì—°ê²°, ë¼ìš°íŒ… | ë„¤íŠ¸ì›Œí¬ ê°ì‚¬ |

---

## ðŸš€ ì„¤ì¹˜ ë°©ë²•

### ë°©ë²• 1: Docker (ê¶Œìž¥)

```bash
# 1. ì—ì´ì „íŠ¸ ì´ë¯¸ì§€ ë¹Œë“œ (Central Serverì—ì„œ)
cd trivy-agent
docker build -t trivy-agent:latest .

# 2. ì´ë¯¸ì§€ë¥¼ ì›ê²© ì„œë²„ë¡œ ì „ì†¡
docker save trivy-agent:latest | ssh user@remote-server docker load

# 3. ì›ê²© ì„œë²„ì—ì„œ ì‹¤í–‰
docker run -d \
  --name trivy-agent \
  --restart unless-stopped \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -e CENTRAL_API_URL=http://central-server:6987/api/agent.php \
  -e AGENT_TOKEN=your-secure-token \
  -e AGENT_ID=server-a-prod \
  -e COLLECTORS=trivy,system,docker \
  -e HEARTBEAT_INTERVAL=60 \
  -e SCAN_INTERVAL=300 \
  trivy-agent:latest
```

### ë°©ë²• 2: ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸

```bash
curl -sSL http://central-server:6987/install-agent.sh | bash -s -- \
  --api-url http://central-server:6987/api/agent.php \
  --token your-secure-token \
  --collectors trivy,system,docker
```

### ë°©ë²• 3: Systemd (ë„¤ì´í‹°ë¸Œ)

```bash
# 1. ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬
sudo mkdir -p /opt/trivy-agent/collectors
sudo cp agent.sh /opt/trivy-agent/
sudo cp collectors/*.sh /opt/trivy-agent/collectors/
sudo chmod +x /opt/trivy-agent/*.sh /opt/trivy-agent/collectors/*.sh

# 2. Trivy ì„¤ì¹˜
curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | \
  sudo sh -s -- -b /usr/local/bin v0.29.2

# 3. Systemd ì„œë¹„ìŠ¤ ìƒì„±
sudo cat > /etc/systemd/system/trivy-agent.service << EOF
[Unit]
Description=Trivy Security Agent
After=network.target docker.service

[Service]
Type=simple
Environment="CENTRAL_API_URL=http://central-server:6987/api/agent.php"
Environment="AGENT_TOKEN=your-secure-token"
Environment="COLLECTORS=trivy,system,docker"
ExecStart=/opt/trivy-agent/agent.sh
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# 4. ì„œë¹„ìŠ¤ ì‹œìž‘
sudo systemctl daemon-reload
sudo systemctl enable trivy-agent
sudo systemctl start trivy-agent
```

### í™˜ê²½ ë³€ìˆ˜ ì„¤ëª…

| ë³€ìˆ˜ | í•„ìˆ˜ | ê¸°ë³¸ê°’ | ì„¤ëª… |
|------|------|--------|------|
| `CENTRAL_API_URL` | âœ… | - | Central Server API ì£¼ì†Œ |
| `AGENT_TOKEN` | âœ… | - | ì¸ì¦ í† í° |
| `AGENT_ID` | âŒ | hostname-uuid | ì—ì´ì „íŠ¸ ê³ ìœ  ID |
| `COLLECTORS` | âŒ | trivy,system,docker | í™œì„±í™”í•  ìˆ˜ì§‘ê¸° |
| `HEARTBEAT_INTERVAL` | âŒ | 60 | í•˜íŠ¸ë¹„íŠ¸ ì£¼ê¸° (ì´ˆ) |
| `SCAN_INTERVAL` | âŒ | 300 | ìžë™ ìŠ¤ìº” ì£¼ê¸° (ì´ˆ) |
| `WATCH_DOCKER_EVENTS` | âŒ | true | Docker ì´ë²¤íŠ¸ ê°ì‹œ |

---

## âš™ï¸ ë™ìž‘ ì›ë¦¬

### 1. ì—ì´ì „íŠ¸ ì‹œìž‘ íë¦„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent ì‹œìž‘  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Central Server  â”‚â”€â”€â”€â”€â–¶â”‚  agents í…Œì´ë¸” ë“±ë¡  â”‚
â”‚  /register API   â”‚     â”‚  ìƒíƒœ: online       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                                          â”‚
       â–¼                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Heartbeat Loop  â”‚                    â”‚  Docker Event Watch â”‚
â”‚  (60ì´ˆ ì£¼ê¸°)      â”‚                    â”‚  (ì‹¤ì‹œê°„)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                          â”‚
       â–¼                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ëª…ë ¹ ìˆ˜ì‹ /ì‹¤í–‰   â”‚                    â”‚  ìƒˆ ì»¨í…Œì´ë„ˆ ê°ì§€    â”‚
â”‚  (scan, collect) â”‚                    â”‚  ìžë™ Trivy ìŠ¤ìº”     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. ë°ì´í„° íë¦„

```
                    Agent                           Central Server
                      â”‚                                   â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
   â”‚                                      â”‚               â”‚
   â–¼                                      â–¼               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚Collectorâ”‚  â”€â”€â”€â”€â”€JSONâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚ Report  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
â”‚ ì‹¤í–‰    â”‚                         â”‚  API    â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
   â”‚                                                      â”‚
   â”‚ system.sh â†’ {"cpu": 45, "memory": 78, ...}          â”‚
   â”‚ docker.sh â†’ {"containers": [...], ...}              â”‚
   â”‚ trivy scan â†’ {"vulnerabilities": [...]}       â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
   â”‚                                               â”‚   MySQL   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ agent_dataâ”‚
                                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. ëª…ë ¹ ì²˜ë¦¬ íë¦„

```
   Admin Dashboard                 Central Server                    Agent
        â”‚                               â”‚                              â”‚
        â”‚  "ì „ì²´ ìŠ¤ìº”" ë²„íŠ¼ í´ë¦­          â”‚                              â”‚
        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                              â”‚
        â”‚                               â”‚                              â”‚
        â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
        â”‚                    â”‚ agent_commands ì €ìž¥  â”‚                   â”‚
        â”‚                    â”‚ status: pending     â”‚                   â”‚
        â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
        â”‚                               â”‚                              â”‚
        â”‚                               â”‚â—€â”€â”€â”€â”€â”€â”€ Heartbeat (60ì´ˆ) â”€â”€â”€â”€â”€â”€â”‚
        â”‚                               â”‚                              â”‚
        â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
        â”‚                    â”‚ ëŒ€ê¸° ëª…ë ¹ ë°˜í™˜       â”‚                   â”‚
        â”‚                    â”‚ {"command": "scan"} â”‚                   â”‚
        â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
        â”‚                               â”‚                              â”‚
        â”‚                               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚
        â”‚                               â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                               â”‚                    â”‚  ëª…ë ¹ ì‹¤í–‰       â”‚
        â”‚                               â”‚                    â”‚  Trivy ìŠ¤ìº”     â”‚
        â”‚                               â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                               â”‚                              â”‚
        â”‚                               â”‚â—€â”€â”€â”€â”€â”€â”€ ê²°ê³¼ ë¦¬í¬íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
        â”‚                               â”‚                              â”‚
        â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
        â”‚                    â”‚ scan_history ì €ìž¥   â”‚                   â”‚
        â”‚                    â”‚ agent_id í¬í•¨       â”‚                   â”‚
        â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
```

---

## ðŸ”Œ Collector í™•ìž¥

### ìƒˆ Collector ë§Œë“¤ê¸°

```bash
#!/bin/bash
# collectors/my_custom.sh
# ë°˜ë“œì‹œ ìœ íš¨í•œ JSONì„ stdoutìœ¼ë¡œ ì¶œë ¥

cat <<EOF
{
    "custom_metric_1": $(some_command | wc -l),
    "custom_metric_2": "$(another_command)",
    "collected_at": "$(date -Iseconds)"
}
EOF
```

### Collector í™œì„±í™”

```bash
# ë°©ë²• 1: í™˜ê²½ ë³€ìˆ˜
-e COLLECTORS=trivy,system,docker,my_custom

# ë°©ë²• 2: ìˆ˜ë™ ì‹¤í–‰
docker exec trivy-agent /opt/agent/collectors/my_custom.sh
```

### ì˜ˆì œ: SSL ì¸ì¦ì„œ ë§Œë£Œ ì²´í¬

```bash
#!/bin/bash
# collectors/ssl_certs.sh

check_cert() {
    local host=$1
    local expiry=$(echo | openssl s_client -servername $host -connect $host:443 2>/dev/null | \
        openssl x509 -noout -enddate 2>/dev/null | cut -d= -f2)
    local days_left=$(( ($(date -d "$expiry" +%s) - $(date +%s)) / 86400 ))
    echo "\"$host\": {\"expiry\": \"$expiry\", \"days_left\": $days_left}"
}

cat <<EOF
{
    "ssl_certificates": {
        $(check_cert "google.com"),
        $(check_cert "github.com")
    },
    "collected_at": "$(date -Iseconds)"
}
EOF
```

---

## ðŸ·ï¸ ìžì‚° ê´€ë¦¬

### ìžì‚° ê·¸ë£¹/íƒœê·¸ ì‹œìŠ¤í…œ

ì—ì´ì „íŠ¸ì™€ ì»¨í…Œì´ë„ˆë¥¼ **íƒœê·¸**ë¡œ ë¶„ë¥˜í•˜ì—¬ ê´€ë¦¬í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.

| íƒœê·¸ ìœ í˜• | ì˜ˆì‹œ | ìš©ë„ |
|----------|------|------|
| **í™˜ê²½** | `dev`, `staging`, `prod` | í™˜ê²½ë³„ ë¶„ë¦¬ |
| **íŒ€** | `backend`, `frontend`, `infra` | íŒ€ë³„ ê´€ë¦¬ |
| **ì„œë¹„ìŠ¤** | `api`, `web`, `db` | ì„œë¹„ìŠ¤ ìœ í˜• |
| **ì¤‘ìš”ë„** | `critical`, `normal`, `low` | ìš°ì„ ìˆœìœ„ |

### ì‚¬ìš© ì˜ˆì‹œ

```bash
# ì—ì´ì „íŠ¸ ë“±ë¡ ì‹œ íƒœê·¸ ì§€ì •
docker run -d \
  --name trivy-agent \
  -e AGENT_TAGS="prod,backend,critical" \
  ...

# ë˜ëŠ” Dashboardì—ì„œ ìˆ˜ë™ íƒœê·¸ ë¶€ì—¬
```

### Grafana í•„í„°ë§

```promql
# í”„ë¡œë•ì…˜ í™˜ê²½ë§Œ ì¡°íšŒ
trivy_vulnerabilities_total{asset_group="prod"}

# ê°œë°œ+ìŠ¤í…Œì´ì§• í™˜ê²½ ì¡°íšŒ
trivy_vulnerabilities_total{asset_group=~"dev|staging"}
```

---

## ðŸ”§ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ì—ì´ì „íŠ¸ê°€ ë“±ë¡ë˜ì§€ ì•ŠìŒ

```bash
# 1. ë„¤íŠ¸ì›Œí¬ í™•ì¸
curl -v http://central-server:6987/api/agent.php?action=list

# 2. í† í° í™•ì¸
docker logs trivy-agent | grep -i "auth\|token\|401"

# 3. ë°©í™”ë²½ í™•ì¸
iptables -L -n | grep 6987
```

### ìŠ¤ìº” ê²°ê³¼ê°€ ì „ì†¡ë˜ì§€ ì•ŠìŒ

```bash
# 1. Trivy ì‹¤í–‰ í™•ì¸
docker exec trivy-agent trivy image alpine:latest

# 2. API í…ŒìŠ¤íŠ¸
docker exec trivy-agent curl -X POST \
  -H "X-Agent-Token: $AGENT_TOKEN" \
  -d '{"data_type":"test","data":"{}"}' \
  "$CENTRAL_API_URL?action=report"
```

### Docker ì´ë²¤íŠ¸ ê°ì‹œ ì•ˆë¨

```bash
# docker.sock ë§ˆìš´íŠ¸ í™•ì¸
docker inspect trivy-agent | grep -A5 Mounts

# ê¶Œí•œ í™•ì¸
docker exec trivy-agent ls -la /var/run/docker.sock
```

---

## ðŸ“Š ëª¨ë‹ˆí„°ë§

### ì—ì´ì „íŠ¸ ìƒíƒœ í™•ì¸

| ìƒíƒœ | ì˜ë¯¸ | ì¡°ì¹˜ |
|------|------|------|
| ðŸŸ¢ Online | ì •ìƒ ë™ìž‘ | - |
| ðŸŸ¡ Error | ë§ˆì§€ë§‰ ìž‘ì—… ì‹¤íŒ¨ | ë¡œê·¸ í™•ì¸ |
| ðŸ”´ Offline | 5ë¶„ ì´ìƒ ë¯¸ì‘ë‹µ | ì—ì´ì „íŠ¸ ìƒíƒœ í™•ì¸ |

### ë¡œê·¸ í™•ì¸

```bash
# Docker
docker logs -f trivy-agent

# Systemd
journalctl -u trivy-agent -f
```

---

## ðŸ” ë³´ì•ˆ ê¶Œìž¥ì‚¬í•­

1. **í† í° ê´€ë¦¬**: `.env` íŒŒì¼ì— ì €ìž¥, ì •ê¸°ì  ê°±ì‹ 
2. **HTTPS ì‚¬ìš©**: í”„ë¡œë•ì…˜ì—ì„œëŠ” TLS í•„ìˆ˜
3. **IP ì œí•œ**: ì•Œë ¤ì§„ ì—ì´ì „íŠ¸ IPë§Œ í—ˆìš©
4. **ìµœì†Œ ê¶Œí•œ**: í•„ìš”í•œ Collectorë§Œ í™œì„±í™”

```bash
# ë³´ì•ˆ ê°•í™” ì‹¤í–‰ ì˜ˆì‹œ
docker run -d \
  --name trivy-agent \
  --read-only \
  --security-opt no-new-privileges \
  --cap-drop ALL \
  --cap-add NET_RAW \
  -v /var/run/docker.sock:/var/run/docker.sock:ro \
  -e CENTRAL_API_URL=https://secure-server.com/api/agent.php \
  -e AGENT_TOKEN=$(cat /run/secrets/agent_token) \
  trivy-agent:latest
```

