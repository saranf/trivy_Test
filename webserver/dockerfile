# Dockerfile for Nginx + PHP 8
FROM php:8-fpm

# Install Nginx and dependencies
RUN apt-get update && apt-get install -y nginx

# Install PHP mysqli extension
RUN docker-php-ext-install mysqli && docker-php-ext-enable mysqli

# Configure Nginx and PHP
COPY default.conf /etc/nginx/sites-available/default
COPY www.conf /usr/local/etc/php-fpm.d/www.conf

# Copy application code
COPY src/ /var/www/html/

# Install Trivy
RUN apt-get update && apt-get install -y wget curl gnupg
RUN wget https://github.com/aquasecurity/trivy/releases/download/v0.29.2/trivy_0.29.2_Linux-64bit.deb
RUN dpkg -i trivy_0.29.2_Linux-64bit.deb

# Install Docker CLI
RUN curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg && \
    echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian bookworm stable" > /etc/apt/sources.list.d/docker.list && \
    apt-get update && apt-get install -y docker-ce-cli

# Add www-data to docker group (GID 999 matches host docker socket)
RUN groupadd -g 999 docker && usermod -aG docker www-data

# Create cache directory and set permissions
RUN mkdir -p /var/www/.cache && chmod -R 777 /var/www/.cache

# Expose port and start PHP-FPM and Nginx
EXPOSE 80
CMD ["sh", "-c", "php-fpm -D && nginx -g 'daemon off;'"]

