version: '3.8'

services:
  nginx:
    image: nginx:latest
    ports:
      - "6987:80"
    volumes:
      - ./webserver/default.conf:/etc/nginx/conf.d/default.conf
      - ./webserver/src:/var/www/html
    depends_on:
      - webserver
    environment:
      - TZ=Asia/Seoul
    networks:
      - app-network

  webserver:
    image: qorwlsdk1995/my-php-app:latest  # Docker Hubì˜ ì´ë¯¸ì§€ ì‚¬ìš©
    ports:
      - "9555:9000"  # Nginxì™€ ì—°ê²°í•˜ê¸° ìœ„í•´ í¬íŠ¸ ì—´ê¸°
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock  # Docker ì†Œì¼“ ë§ˆìš´íŠ¸
      - ./webserver/www.conf:/usr/local/etc/php-fpm.d/www.conf  # PHP-FPM ì„¤ì •
      - ./webserver/src:/var/www/html  # ì†ŒìŠ¤ ì½”ë“œ ê³µìœ 
      - ./webserver/entrypoint.sh:/entrypoint.sh  # ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸
    entrypoint: ["/bin/bash", "/entrypoint.sh"]
    environment:
      - TZ=Asia/Seoul
      - FROM_EMAIL=trivy-scanner@monitor.rmstudio.co.kr
      - FROM_NAME=Trivy Scanner
      - ALERT_EMAIL=qorwlsdk1995@naver.com
      - ALERT_ON_CRITICAL=true
      - ALERT_THRESHOLD=HIGH
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      # Slack Webhook ì„¤ì • (ì—¬ëŸ¬ URLì€ ì‰¼í‘œë¡œ êµ¬ë¶„)
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL:-}
      # Google Spreadsheet ì„¤ì •
      - GOOGLE_SHEET_ID=${GOOGLE_SHEET_ID:-}
      - GOOGLE_SERVICE_ACCOUNT_KEY=/var/www/html/google-credentials.json
    depends_on:
      - mysql
    networks:
      - app-network

  mysql:
    image: mysql:8.0
    environment:
      - TZ=Asia/Seoul
      - MYSQL_ROOT_PASSWORD=root_password
      - MYSQL_DATABASE=trivy_db
      - MYSQL_USER=trivy_user
      - MYSQL_PASSWORD=trivy_password
    ports:
      - "9756:3306"
    volumes:
      - mysql_data:/var/lib/mysql  # ğŸš¨ ë°ì´í„° ì˜êµ¬ ì €ì¥
    networks:
      - app-network

  auto_scan:
    build: ./auto_scan
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - TZ=Asia/Seoul
      - API_URL=http://nginx:80/auto_scan.php
    depends_on:
      - nginx
    restart: unless-stopped
    networks:
      - app-network

  # Prometheus - ë©”íŠ¸ë¦­ ìˆ˜ì§‘
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    environment:
      - TZ=Asia/Seoul
    restart: unless-stopped
    networks:
      - app-network

  # Grafana - ì‹œê°í™”
  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - TZ=Asia/Seoul
      - GF_SECURITY_ADMIN_PASSWORD=admin123
      # ìµëª… ì ‘ê·¼ í—ˆìš© (ë¡œê·¸ì¸ ì—†ì´ ëŒ€ì‹œë³´ë“œ ë³´ê¸°)
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_NAME=Main Org.
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
      # ì„ë² ë”© í—ˆìš© (iframe ì‚¬ìš©ì‹œ)
      - GF_SECURITY_ALLOW_EMBEDDING=true
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - prometheus
      - loki
    restart: unless-stopped
    networks:
      - app-network

  # cAdvisor - ì»¨í…Œì´ë„ˆ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    ports:
      - "8080:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    environment:
      - TZ=Asia/Seoul
    restart: unless-stopped
    networks:
      - app-network

  # Postfix - ë©”ì¼ ë°œì†¡ ì„œë²„
  mailserver:
    image: boky/postfix
    environment:
      - TZ=Asia/Seoul
      - ALLOWED_SENDER_DOMAINS=monitor.rmstudio.co.kr rmstudio.co.kr
      - HOSTNAME=mail.monitor.rmstudio.co.kr
    restart: unless-stopped
    networks:
      - app-network

  # ğŸ”­ Loki - ë¡œê·¸ ì €ì¥ì†Œ
  loki:
    image: grafana/loki:2.9.0
    ports:
      - "3100:3100"
    volumes:
      - ./loki/loki-config.yml:/etc/loki/local-config.yaml
      - loki_data:/loki
    command: -config.file=/etc/loki/local-config.yaml
    environment:
      - TZ=Asia/Seoul
    restart: unless-stopped
    networks:
      - app-network

  # ğŸ”­ Promtail - ë¡œê·¸ ìˆ˜ì§‘ê¸°
  promtail:
    image: grafana/promtail:2.9.0
    user: root  # ğŸš¨ Docker ë¡œê·¸ íŒŒì¼ ì½ê¸° ê¶Œí•œ í•„ìš”
    volumes:
      - ./promtail/promtail-config.yml:/etc/promtail/config.yml
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    command: -config.file=/etc/promtail/config.yml
    environment:
      - TZ=Asia/Seoul
    depends_on:
      - loki
    restart: unless-stopped
    networks:
      - app-network

  # ğŸ¦… Falco - ëŸ°íƒ€ì„ ìœ„í˜‘ íƒì§€ (ì„ íƒì‚¬í•­)
  # âš ï¸ ì£¼ì˜: FalcoëŠ” Linux ì»¤ë„ ëª¨ë“ˆì´ í•„ìš”í•©ë‹ˆë‹¤.
  # Docker Desktop(Mac/Windows)ì—ì„œëŠ” ë™ì‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
  # Linux ì„œë²„ì—ì„œë§Œ í™œì„±í™”í•˜ì„¸ìš”.
  # falco:
  #   image: falcosecurity/falco:latest
  #   privileged: true
  #   volumes:
  #     - /var/run/docker.sock:/host/var/run/docker.sock:ro
  #     - /dev:/host/dev:ro
  #     - /proc:/host/proc:ro
  #     - /boot:/host/boot:ro
  #     - /lib/modules:/host/lib/modules:ro
  #     - /usr:/host/usr:ro
  #     - /etc:/host/etc:ro
  #     - ./falco/falco.yaml:/etc/falco/falco.yaml
  #   environment:
  #     - TZ=Asia/Seoul
  #   restart: unless-stopped
  #   networks:
  #     - app-network

  # ğŸ¦… Falco Sidekick - Falco ì´ë²¤íŠ¸ë¥¼ Lokië¡œ ì „ì†¡
  # falco-sidekick:
  #   image: falcosecurity/falcosidekick:latest
  #   environment:
  #     - TZ=Asia/Seoul
  #     - LOKI_HOSTPORT=http://loki:3100
  #   depends_on:
  #     - falco
  #     - loki
  #   restart: unless-stopped
  #   networks:
  #     - app-network

networks:
  app-network:
    driver: bridge

volumes:
  prometheus_data:
  grafana_data:
  mysql_data:      # ğŸš¨ MySQL ë°ì´í„° ì˜êµ¬ ì €ì¥
  loki_data:       # ğŸ”­ Loki ë¡œê·¸ ë°ì´í„°

